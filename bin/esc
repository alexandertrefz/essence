#!/usr/bin/env node

const process = require("process")
const fs = require("fs")
const path = require("path")

const meow = require("meow")

const Parser = require("../lib/parser")
const Enricher = require("../lib/enricher")
const Validator = require("../lib/validator")
const Simplifier = require("../lib/simplifier")
const Optimiser = require("../lib/optimiser")
const Rewriter = require("../lib/rewriter")

const compile = (inputFileName, flags) => {
	const sourceFileNameParsed = path.parse(inputFileName)
	const targetFileName = sourceFileNameParsed.dir + "/" + sourceFileNameParsed.name + ".js"

	fs.readFile(inputFileName, "utf8", (err, data) => {
		const initialAST = Parser.parse(data)
		const enrichedAST = Enricher.enrich(initialAST)
		const validatedAST = Validator.validate(enrichedAST)
		const simplifiedAST = Simplifier.simplify(validatedAST)
		const optimisedAST = Optimiser.optimise(simplifiedAST)
		const result = Rewriter.rewrite(optimisedAST, flags.mode)

		fs.writeFile(targetFileName, result, err => {
			if (err) {
				throw err
			} else {
				console.log(`Successfully compiled ${inputFileName} -> ${targetFileName}`)
			}
		})
	})
}

const cli = meow(
	{
		help: `
			Usage
			    $ esc <fileName>

			Options
			    --mode Set the rewriter mode

			Examples
			    $ foo HelloWorld.es --mode js
		`,
		description: false,
	},
	{
		flags: {
			mode: {
				type: "string",
				default: "js",
			},
		},
	},
)

compile(cli.input[0], Object.assign({ mode: "js" }, cli.flags))
